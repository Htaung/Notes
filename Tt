package com.example.listener;

import com.liferay.portal.kernel.events.LifecycleAction;
import com.liferay.portal.kernel.events.LifecycleEvent;
import com.liferay.portal.kernel.log.Log;
import com.liferay.portal.kernel.log.LogFactoryUtil;

import java.net.HttpURLConnection;
import java.net.URL;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;

@Component(
    property = "key=portal.instance.lifecycle.on.startup.events",
    service = LifecycleAction.class,
    immediate = true
)
public class StartupLifecycleAction implements LifecycleAction {

    private static final Log _log =
            LogFactoryUtil.getLog(StartupLifecycleAction.class);

    private final ScheduledExecutorService scheduler =
            Executors.newSingleThreadScheduledExecutor();

    @Override
    public void processLifecycleEvent(LifecycleEvent lifecycleEvent) {

        _log.info("Portal fully started. Scheduling API call in 5 minutes...");

        scheduler.schedule(
            this::triggerApiCall,
            5,
            TimeUnit.MINUTES
        );
    }

    private void triggerApiCall() {
        try {
            _log.info("Executing delayed API call...");

            URL url = new URL("https://your-api.com/endpoint");
            HttpURLConnection connection =
                    (HttpURLConnection) url.openConnection();

            connection.setRequestMethod("GET");
            connection.setConnectTimeout(10000);
            connection.setReadTimeout(10000);

            int responseCode = connection.getResponseCode();

            _log.info("API Response Code: " + responseCode);

        } catch (Exception e) {
            _log.error("Error while calling API", e);
        }
    }

    @Deactivate
    protected void deactivate() {

        _log.info("Shutting down scheduler...");

        scheduler.shutdown();

        try {
            if (!scheduler.awaitTermination(10, TimeUnit.SECONDS)) {
                scheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            scheduler.shutdownNow();
        }
    }
}
